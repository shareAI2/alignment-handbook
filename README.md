<p align="center">
  <img src="https://raw.githubusercontent.com/huggingface/alignment-handbook/main/assets/handbook.png">
</p>

<p align="center">
    ğŸ¤— <a href="https://huggingface.co/collections/alignment-handbook/handbook-v01-models-and-datasets-654e424d22e6880da5ebc015" target="_blank">Models & Datasets</a> | ğŸ“ƒ <a href="https://arxiv.org/abs/2310.16944" target="_blank">Technical Report</a>
</p>

# å¯¹é½æ‰‹å†Œ

ç¨³å¥çš„æ–¹æ³•ï¼Œç”¨äºç»§ç»­é¢„è®­ç»ƒå’Œå°†è¯­è¨€æ¨¡å‹ä¸äººç±»å’Œ AI åå¥½å¯¹é½ã€‚

## è¿™æ˜¯ä»€ä¹ˆï¼Ÿ

ä»…ä»…ä¸€å¹´å‰ï¼ŒèŠå¤©æœºå™¨äººå·²ç»è¿‡æ—¶ï¼Œå¤§å¤šæ•°äººè¿˜æ²¡æœ‰å¬è¯´è¿‡é€šè¿‡äººç±»åé¦ˆè¿›è¡Œå¼ºåŒ–å­¦ä¹ ï¼ˆRLHFï¼‰æ¥å°†è¯­è¨€æ¨¡å‹ä¸äººç±»åå¥½å¯¹é½ç­‰æŠ€æœ¯ã€‚ç„¶åï¼ŒOpenAI æ¨å‡ºäº† ChatGPTï¼ŒMetaç´§éšå…¶åå‘å¸ƒäº† Llama ç³»åˆ—çš„è¯­è¨€æ¨¡å‹ï¼Œä½¿å¾—æœºå™¨å­¦ä¹ ç¤¾åŒºèƒ½å¤Ÿæ„å»ºè‡ªå·±çš„åŠŸèƒ½å¼ºå¤§çš„èŠå¤©æœºå™¨äººã€‚è¿™å¯¼è‡´äº†ä¸€ä¸ªä¸°å¯Œçš„æ•°æ®é›†å’Œæ¨¡å‹ç”Ÿæ€ç³»ç»Ÿï¼Œè¿™äº›æ•°æ®é›†å’Œæ¨¡å‹ä¸»è¦é›†ä¸­åœ¨é€šè¿‡ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰æ•™å¯¼è¯­è¨€æ¨¡å‹éµå¾ªæŒ‡ä»¤ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬ä» [InstructGPT](https://huggingface.co/papers/2203.02155) å’Œ [Llama2](https://huggingface.co/papers/2307.09288) è®ºæ–‡ä¸­å¾—çŸ¥ï¼Œé€šè¿‡å¢åŠ äººç±»ï¼ˆæˆ– AIï¼‰åå¥½æ¥å¢å¼º SFT å¯ä»¥å¸¦æ¥æ˜¾è‘—çš„å¸®åŠ©å’Œå®‰å…¨æ€§æå‡ã€‚åŒæ—¶ï¼Œå°†è¯­è¨€æ¨¡å‹ä¸ä¸€ç»„åå¥½å¯¹é½æ˜¯ä¸€ä¸ªç›¸å½“æ–°é¢–çš„æƒ³æ³•ï¼Œç›®å‰è¿˜æ²¡æœ‰å¤ªå¤šå…¬å¼€èµ„æºå¯ç”¨äºæŒ‡å¯¼å¦‚ä½•è®­ç»ƒè¿™äº›æ¨¡å‹ã€æ”¶é›†ä»€ä¹ˆæ ·çš„æ•°æ®ä»¥åŠè¡¡é‡æœ€ä½³ä¸‹æ¸¸æ€§èƒ½çš„æŒ‡æ ‡ã€‚

å¯¹é½æ‰‹å†Œæ—¨åœ¨é€šè¿‡æä¾›ä¸€ç³»åˆ—ç¨³å¥çš„è®­ç»ƒæ–¹æ³•æ¥å¡«è¡¥è¿™ä¸€ç©ºç™½ã€‚

## æ–°é—» ğŸ—ï¸
* **2024å¹´4æœˆ12æ—¥**ï¼šæˆ‘ä»¬ä¸ Argilla å’Œ Kaist AI åˆä½œå‘å¸ƒäº† Zephyr 141B (A35B)ï¼ŒåŒæ—¶æä¾›äº†ä½¿ç”¨ ORPO å¯¹ Mixtral 8x22B è¿›è¡Œå¾®è°ƒçš„æ–¹æ³• ğŸª
* **2024å¹´3æœˆ12æ—¥**ï¼šæˆ‘ä»¬å‘å¸ƒäº† StarChat2 15Bï¼Œå¹¶æä¾›äº†è®­ç»ƒèƒ½åŠ›å¼ºå¤§çš„ç¼–ç åŠ©æ‰‹çš„æ–¹æ³• ğŸŒŸ
* **2024å¹´3æœˆ1æ—¥**ï¼šæˆ‘ä»¬å‘å¸ƒäº† Zephyr 7B Gemmaï¼Œè¿™æ˜¯ä¸€ç§å°† Gemma 7B ä¸ RLAIF å¯¹é½çš„æ–°æ–¹æ³• ğŸ”¥
* **2024å¹´2æœˆ1æ—¥**ï¼šæˆ‘ä»¬å‘å¸ƒäº†ä¸€ç§ä½¿ç”¨å®ªæ³• AI å¯¹å¼€æ”¾ LLM è¿›è¡Œå¯¹é½çš„æ–¹æ³• ğŸ“œï¼è¯·å‚é˜…[é…æ–¹](https://github.com/huggingface/alignment-handbook/tree/main/recipes/constitutional-ai)å’Œ[åšå®¢æ–‡ç« ](https://huggingface.co/blog/constitutional_ai)äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚
* **2024å¹´1æœˆ18æ—¥**ï¼šæˆ‘ä»¬å‘å¸ƒäº† DPO vs KTO vs IPO çš„ä¸€ç³»åˆ—è¯„ä¼°ï¼Œè¯¦è§[é…æ–¹](recipes/pref_align_scan/README.md)å’Œ[åšå®¢æ–‡ç« ](https://huggingface.co/blog/pref-tuning)ã€‚
* **2023å¹´11æœˆ10æ—¥**ï¼šæˆ‘ä»¬å‘å¸ƒäº†å¤åˆ¶ Zephyr-7b-Î² çš„æ‰€æœ‰è®­ç»ƒä»£ç  ğŸªï¼æˆ‘ä»¬è¿˜å‘å¸ƒäº†[No Robots](https://huggingface.co/datasets/HuggingFaceH4/no_robots)ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„æ•°æ®é›†ï¼Œç”±ç†Ÿç»ƒçš„äººç±»æ ‡æ³¨è€…å®Œå…¨ç¼–å†™çš„ 10,000 æ¡æŒ‡ä»¤å’Œæ¼”ç¤ºã€‚

## é“¾æ¥ ğŸ”—

* [Zephyr 7B æ¨¡å‹ã€æ•°æ®é›†å’Œæ¼”ç¤º](https://huggingface.co/collections/HuggingFaceH4/zephyr-7b-6538c6d6d5ddd1cbb1744a66)

## å¦‚ä½•æµè§ˆæ­¤é¡¹ç›® ğŸ§­

æœ¬é¡¹ç›®è®¾è®¡ç®€å•ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š

* [`scripts`](./scripts/)ï¼šç”¨äºè®­ç»ƒå’Œè¯„ä¼°æ¨¡å‹çš„è„šæœ¬ã€‚åŒ…æ‹¬å››ä¸ªæ­¥éª¤ï¼šç»§ç»­é¢„è®­ç»ƒã€èŠå¤©çš„ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰ã€ä½¿ç”¨ DPO è¿›è¡Œåå¥½å¯¹é½ï¼Œä»¥åŠä½¿ç”¨ ORPO è¿›è¡Œå¸¦åå¥½å¯¹é½çš„ç›‘ç£å¾®è°ƒã€‚æ¯ä¸ªè„šæœ¬éƒ½æ”¯æŒä½¿ç”¨ DeepSpeed ZeRO-3 è¿›è¡Œå®Œæ•´æ¨¡å‹æƒé‡çš„åˆ†å¸ƒå¼è®­ç»ƒï¼Œæˆ–è€…ä½¿ç”¨ LoRA/QLoRA è¿›è¡Œå‚æ•°é«˜æ•ˆçš„å¾®è°ƒã€‚
* [`recipes`](./recipes/)ï¼šç”¨äºå¤ç° Zephyr 7B ç­‰æ¨¡å‹çš„é…æ–¹é…ç½®æ–‡ä»¶ã€‚æ¯ä¸ªé…æ–¹é‡‡ç”¨ YAML æ–‡ä»¶çš„å½¢å¼ï¼Œå…¶ä¸­åŒ…å«ä¸å•ä¸ªè®­ç»ƒè¿è¡Œç›¸å…³çš„æ‰€æœ‰å‚æ•°ã€‚è¿˜æä¾›äº†ä¸€ä¸ª `gpt2-nl` é…æ–¹ï¼Œç”¨äºè¯´æ˜å¦‚ä½•ä½¿ç”¨æœ¬æ‰‹å†Œè¿›è¡Œè¯­è¨€æˆ–é¢†åŸŸé€‚åº”ï¼Œä¾‹å¦‚é€šè¿‡åœ¨ä¸åŒè¯­è¨€ä¸Šç»§ç»­é¢„è®­ç»ƒï¼Œç„¶åå¯¹ç»“æœè¿›è¡Œ SFT å’Œ DPO è°ƒä¼˜ã€‚

æˆ‘ä»¬è¿˜åœ¨ç¼–å†™ä¸€ç³»åˆ—æŒ‡å—ï¼Œä»¥è§£é‡Šç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰ç­‰æ–¹æ³•çš„å·¥ä½œåŸç†ï¼Œä»¥åŠä»å®è·µä¸­æ”¶é›†äººç±»åå¥½çš„ç»éªŒæ•™è®­ã€‚è¦å¼€å§‹ï¼Œè¯·å‚é˜…ä»¥ä¸‹å†…å®¹ï¼š

1. æŒ‰ç…§[å®‰è£…è¯´æ˜](#installation-instructions)è®¾ç½®ç¯å¢ƒç­‰ã€‚
2. é€šè¿‡æŒ‰ç…§[é…æ–¹è¯´æ˜](./recipes/zephyr-7b-beta/README.md)å¤åˆ¶ Zephyr-7b-Î²ã€‚

å¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè®­ç»ƒèŠå¤©æ¨¡å‹ï¼Œæˆ‘ä»¬å»ºè®®æŒ‰ç…§[æ­¤å¤„](./scripts/README.md#fine-tuning-on-your-datasets)çš„æ•°æ®é›†æ ¼å¼åŒ–è¯´æ˜è¿›è¡Œæ“ä½œã€‚

## å†…å®¹

æ‰‹å†Œçš„åˆå§‹ç‰ˆæœ¬å°†é‡ç‚¹ä»‹ç»ä»¥ä¸‹æŠ€æœ¯ï¼š

* **ç»§ç»­é¢„è®­ç»ƒ**ï¼šå°†è¯­è¨€æ¨¡å‹é€‚åº”åˆ°æ–°çš„è¯­è¨€æˆ–é¢†åŸŸï¼Œæˆ–è€…é€šè¿‡åœ¨æ–°æ•°æ®é›†ä¸Šç»§ç»­é¢„è®­ç»ƒï¼ˆå› æœè¯­è¨€å»ºæ¨¡ï¼‰æ¥æ”¹è¿›å®ƒã€‚
* **ç›‘ç£å¾®è°ƒ**ï¼šæ•™å¯¼è¯­è¨€æ¨¡å‹éµå¾ªæŒ‡ä»¤çš„æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•æ”¶é›†å’Œæ•´ç†è‡ªå·±çš„è®­ç»ƒæ•°æ®é›†çš„æŠ€å·§ã€‚
* **å¥–åŠ±å»ºæ¨¡**ï¼šæ•™å¯¼è¯­è¨€æ¨¡å‹æ ¹æ®äººç±»æˆ– AI åå¥½åŒºåˆ†æ¨¡å‹å“åº”çš„æ–¹æ³•ã€‚
* **æ‹’ç»æŠ½æ ·**ï¼šä¸€ç§ç®€å•ä½†å¼ºå¤§çš„æŠ€æœ¯ï¼Œå¯ä»¥æé«˜ SFT æ¨¡å‹çš„æ€§èƒ½ã€‚
* **ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰**ï¼šä¸€ç§å¼ºå¤§ä¸”æœ‰å‰æ™¯çš„ PPO æ›¿ä»£æ–¹æ³•ã€‚
* **èµ”ç‡æ¯”åå¥½ä¼˜åŒ–ï¼ˆORPOï¼‰**ï¼šä¸€ç§å°†äººç±»åå¥½ä¸ SFT å’Œ DPO ç»“åˆåœ¨å•ä¸ªé˜¶æ®µä¸­å¾®è°ƒè¯­è¨€æ¨¡å‹çš„æŠ€æœ¯ã€‚

## å®‰è£…è¯´æ˜

è¦è¿è¡Œæ­¤é¡¹ç›®ä¸­çš„ä»£ç ï¼Œé¦–å…ˆä½¿ç”¨ Conda åˆ›å»ºä¸€ä¸ª Python è™šæ‹Ÿç¯å¢ƒï¼š

```shell
conda create -n handbook python=3.10 && conda activate handbook
```

ç„¶åï¼Œå®‰è£… PyTorch `v2.1.2` - ç²¾ç¡®çš„ç‰ˆæœ¬å¯¹äºå¯é‡ç°æ€§å¾ˆé‡è¦ï¼ç”±äºè¿™å–å†³äºç¡¬ä»¶ï¼Œæˆ‘ä»¬å°†æ‚¨å¼•å¯¼åˆ°[PyTorchå®‰è£…é¡µé¢](https://pytorch.org/get-started/locally/)ã€‚

æ¥ä¸‹æ¥ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼å®‰è£…å…¶ä½™çš„è½¯ä»¶åŒ…ä¾èµ–é¡¹ï¼š

```shell
git clone https://github.com/huggingface/alignment-handbook.git
cd ./alignment-handbook/
python -m pip install .
```

æ‚¨è¿˜éœ€è¦å®‰è£… Flash Attention 2ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å®Œæˆï¼š

```shell
python -m pip install flash-attn --no-build-isolation
```

> **æ³¨æ„**
> å¦‚æœæ‚¨çš„è®¡ç®—æœºå†…å­˜å°‘äº 96GBï¼Œå¹¶ä¸”å…·æœ‰è®¸å¤š CPU æ ¸å¿ƒï¼Œè¯·å‡å°‘ `MAX_JOBS` å‚æ•°ï¼Œä¾‹å¦‚ `MAX_JOBS=4 pip install flash-attn --no-build-isolation`

ç„¶åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤ç™»å½•æ‚¨çš„ Hugging Face è´¦æˆ·ï¼š

```shell
huggingface-cli login
```

æœ€åï¼Œå®‰è£… Git LFSï¼Œä»¥ä¾¿æ‚¨å¯ä»¥å°†æ¨¡å‹æ¨é€åˆ° Hugging Face Hubï¼š

```shell
sudo apt-get install git-lfs
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ `scripts` å’Œ `recipes` ç›®å½•ï¼Œäº†è§£å¦‚ä½•è®­ç»ƒä¸€äº›æ¨¡å‹ ğŸªï¼

## é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ LICENSE
â”œâ”€â”€ Makefile                    <- åŒ…å«è¯¸å¦‚ `make style` ç­‰å‘½ä»¤çš„ Makefile
â”œâ”€â”€ README.md                   <- å¼€å‘äººå‘˜ä½¿ç”¨çš„é¡¶çº§ README
â”œâ”€â”€ chapters                    <- åœ¨ hf.co/learn ä¸Šå‘ˆç°çš„æ•™è‚²å†…å®¹
â”œâ”€â”€ recipes                     <- é…æ–¹é…ç½®æ–‡ä»¶ã€åŠ é€Ÿé…ç½®ã€slurm è„šæœ¬
â”œâ”€â”€ scripts                     <- ç”¨äºè®­ç»ƒå’Œè¯„ä¼°èŠå¤©æ¨¡å‹çš„è„šæœ¬
â”œâ”€â”€ setup.cfg                   <- å®‰è£…é…ç½®ï¼ˆä¸»è¦ç”¨äºé…ç½®ä»£ç è´¨é‡å’Œæµ‹è¯•ï¼‰
â”œâ”€â”€ setup.py                    <- ä½¿é¡¹ç›®å¯é€šè¿‡ pip å®‰è£…ï¼ˆpip install -e .ï¼‰ï¼Œä»¥ä¾¿å¯ä»¥å¯¼å…¥ `alignment`
â”œâ”€â”€ src                         <- ç”¨äºæ­¤é¡¹ç›®çš„æºä»£ç 
â””â”€â”€ tests                       <- å•å…ƒæµ‹è¯•
```

## å¼•ç”¨

å¦‚æœæ‚¨åœ¨å·¥ä½œä¸­å‘ç°è¿™ä¸ªä»“åº“çš„å†…å®¹å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œå¼•ç”¨ï¼š

```bibtex
@misc{alignment_handbook2023,
  author = {Lewis Tunstall and Edward Beeching and Nathan Lambert and Nazneen Rajani and Shengyi Huang and Kashif Rasul and Alexander M. Rush and Thomas Wolf},
  title = {The Alignment Handbook},
  year = {2023},
  publisher = {GitHub},
  journal = {GitHub repository},
  howpublished = {\url{https://github.com/huggingface/alignment-handbook}}
}
```
